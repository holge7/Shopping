package holge.shopping.userservice.kafka;

import java.util.HashMap;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.context.annotation.Configuration;
import org.springframework.kafka.annotation.KafkaListener;
import org.springframework.kafka.core.KafkaTemplate;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;

import commons.dto.ApiResponse;
import commons.dto.UserDTO;
import holge.shopping.userservice.service.UserService;

@Configuration
public class UserConsumer {
	Logger log = LoggerFactory.getLogger(UserConsumer.class);
	
	UserService userService;
	private KafkaTemplate<String, Object> kafkaTemplate;
	
	public UserConsumer(UserService userService, KafkaTemplate<String, Object> kafkaTemplate) {
		this.userService = userService;
		this.kafkaTemplate = kafkaTemplate;
	}
	
    @KafkaListener(id = "myId", topics = "login")
    public String listen(String userSerialize) throws JsonProcessingException {
    	HashMap<String, String> userDeserialize = new ObjectMapper().readValue(userSerialize, HashMap.class);
    	
    	UserDTO userDTO = userService.login(userDeserialize.get("email"), userDeserialize.get("password"));
    	
    	ApiResponse response = new ApiResponse(false, "", userDTO);
    	System.out.println(response);
    	return "Hello world!";
    }
    
    
	@KafkaListener(topics = "login-request-topic", groupId = "group_id")
	public void consume(HashMap<String, String> msg) {
		UserDTO userDTO = userService.login(msg.get("email"), msg.get("password"));
		ApiResponse response = new ApiResponse(false, "", userDTO);
		kafkaTemplate.send("login-response-topic", response);
	}
    
    
}
